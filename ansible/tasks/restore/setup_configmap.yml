- name: Check if ConfigMap already exists
  ansible.builtin.command: kubectl get configmap {{ resource_modifier_configmap }} -n {{ velero_namespace }} -o name
  register: cm_check
  failed_when: false
  changed_when: false

- name: Create ConfigMap YAML if not exists
  ansible.builtin.copy:
    src: "{{ 'files/change-storage-class-config-azure.yaml' if cloud_provider == 'azure' else 'files/change-storage-class-config-vsphere.yaml' }}"
    dest: /tmp/{{ resource_modifier_configmap }}.yaml
  when: cm_check.rc != 0

- name: Apply ConfigMap
  ansible.builtin.command: kubectl apply -f /tmp/{{ resource_modifier_configmap }}.yaml
  when: cm_check.rc != 0

- name: Verify ConfigMap creation
  ansible.builtin.command: kubectl get configmap {{ resource_modifier_configmap }} -n {{ velero_namespace }} -o yaml
  register: cm_info
  changed_when: false

- name: Display ConfigMap info
  ansible.builtin.debug:
    msg: "{{ cm_info.stdout }}"

