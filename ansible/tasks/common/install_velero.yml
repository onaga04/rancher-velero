---
- name: Install Velero in Kubernetes cluster (Azure)
  hosts: localhost
  gather_facts: no
  vars:
    velero_bucket: "{{ lookup('env', 'azure_blob_container') }}"
    velero_resource_group: "{{ lookup('env', 'azure_backup_resource_group') }}"
    velero_storage_account: "{{ lookup('env', 'azure_storage_account') }}"
    velero_subscription_id: "{{ lookup('env', 'azure_subscription_id') }}"
    velero_tenant_id: "{{ lookup('env', 'azure_tenant_id') }}"
    velero_client_id: "{{ lookup('env', 'azure_client_id') }}"
    velero_client_secret: "{{ lookup('env', 'azure_client_secret') }}"
    velero_backup_location: "azure"

  tasks:
    - name: Install Velero CLI (if missing)
      ansible.builtin.include_tasks: install_velero_cli.yml

    - name: Login to Azure
      ansible.builtin.include_tasks: azure_login.yml

    - name: Install Velero with Azure plugin
      ansible.builtin.command: >
        velero install
        --provider azure 
        --plugins velero/velero-plugin-for-microsoft-azure:v1.12.2 
        --bucket {{ velero_bucket }} 
        --secret-file ./credentials-velero.txt \
        --backup-location-config resourceGroup={{ velero_resource_group }},storageAccount={{ velero_storage_account }},subscriptionId={{ velero_subscription_id }}
        --features=EnableCSI \
        --use-node-agent
      register: velero_install_output
      changed_when: "'Velero is already installed' not in velero_install_output.stdout"

    - name: Verify Velero installation in cluster
      ansible.builtin.command: kubectl get pods -n velero
      register: velero_pods
      changed_when: false

    - name: Display Velero pods
      ansible.builtin.debug:
        msg: "{{ velero_pods.stdout_lines }}"

